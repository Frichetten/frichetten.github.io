<!DOCTYPE HTML>
<html>
	<head>
		<title>XXE Attack Basics</title>
        <meta name="description" content="An introduction to exploiting XXE vulnerabilities.">
        <meta property="og:image" content="/images/xxe-attacks/banner-image.png">
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<link rel="stylesheet" href="/assets/css/main.css" />
        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>
        <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
        <script src="/js/firebase.js"></script>
        <script src="/js/FireTraffic-DB.js"></script>
	</head>
	<body class="single">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Header -->
					<header id="header">
						<h1><a href="#">Nick Frichette</a></h1>
						<nav class="links">
							<ul>
								<li><a href="/">Home</a></li>
								<li><a href="/blog">Blog</a></li>
								<li><a href="/Resume.pdf">Resume</a></li>
								<li><a href="https://github.com/frichetten">GitHub</a></li>
								<li><a href="/projects">Projects</a></li>
                                <li><a href="/contact">Contact Me</a></li>
							</ul>
						</nav>
						<nav class="main">
							<ul>
								<li class="menu">
									<a class="fa-bars" href="#menu">Menu</a>
								</li>
							</ul>
						</nav>
					</header>

				<!-- Menu -->
					<section id="menu">

						<!-- Links -->
							<section>
								<ul class="links">
									<li>
										<a href="/">
											<h3>Home</h3>
										</a>
									</li>
									<li>
										<a href="/blog">
											<h3>Blog</h3>
										</a>
									</li>
									<li>
										<a href="/Resume.pdf">
											<h3>Resume</h3>
										</a>
									</li>
                                    <li>
										<a href="https://github.com/frichetten">
											<h3>GitHub</h3>
										</a>
									</li>
                                    <li>
										<a href="/projects">
											<h3>Projects</h3>
										</a>
									</li>
                                    <li>
										<a href="/contact">
											<h3>Contact Me</h3>
										</a>
									</li>
								</ul>
							</section>

					</section>

				<!-- Main -->
					<div id="main">

						<!-- Post -->
							<article class="post">
								<header>
									<div class="title">
										<h2>XXE Attack Basics</h2>
										<p>An introduction to exploiting XXE vulnerabilities.</p>
									</div>
									<div class="meta">
										<time class="published" datetime="2017-3-24">March 24, 2017</time>
									</div>
								</header>
                                <p>The XML External Entity attack (also known as XXE) is a fairly common issue with XML parsers in web applications. Many languages, such as Java, are unprotected from this attack by default. For this article I’d like to explain the basics of how this attack works and how it can be exploited on a system.</p>
                                
                                <h3>How it works</h3>
                                
                                <p>XXE attacks rely on the “external general parsed entity” (or in short, external entity). Essentially, there is a feature in the XML standard that allows you to point to another location and say, “there is more XML information over there”. As this article says, external entities are useful for “creating a common reference that can be shared between multiple documents”.</p>
                                
                                <p>The problem is that this nifty feature can serve as an attack vector under the right circumstances.</p>
                                
                                <h3>How to exploit</h3>
                                
                                <p>XXE vulnerabilities come in many different flavors. For some you can exploit by uploading an XML file to a website (Microsoft Word .docx files are XML...could you use that as an attack vector? Yes!). For others you can do it in a POST command. For the purposes of this article I will create a simple XML parser using Java and then create a custom XML file that will exploit the vulnerability.</p>
                                
                                <p>To begin, we need an XML parser. I chose Java for the language because it is a common language used for web applications (and because I haven’t played with the language in a little while).</p>
                                
                                <pre><code>
import java.io.File;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;

public class Driver {

    public static void main(String[] args) {
        try{
            File file = new File("test.xml");
            DocumentBuilderFactory dBFactory = DocumentBuilderFactory.newInstance();
            DocumentBuilder dBuilder = dBFactory.newDocumentBuilder();
            Document doc = dBuilder.parse(file);
            System.out.println(doc.getElementsByTagName("rootNode").item(0).getTextContent());
        }
        catch(Exception e){
            System.out.println(e);
        }
    }
}
                                </code></pre>
                                
                                <p>This is a standard XML parser (more specifically it’s a DOM parser). We are using the standard Java libraries to build the factory, instantiate an instance, then parse the file. After that we are printing out a value for something called the “rootNode” (name is arbitrary).</p>
                                
                                <p>Our next goal will be to craft the XML file to perform the exploit. As you can see in the Java code, we are calling this file “test.xml”, although this name is arbitrary.</p>
                                
<pre><code><xmp><?xml version="1.0"?>
<!DOCTYPE vulnerableDocType [
	<!ENTITY vuln SYSTEM "file:///home/nick/workspace/XXE/disclose.txt">
]>
<rootNode>&vuln;</rootNode></xmp></code></pre>
                                
                                <p>What looks like a normal XML file is so much more. We declare the file type on line 1. In line 2 we are declaring a document type called “vulnerableDocType” (again, the name is arbitrary). This is the section where we will make use of the external entity. In line 3 we create an entity called “vuln” which calls to the system and asks for a file. This file is arbitrary, you can ask for any file that the system has access to. After that, in line 5, we place the value (literally the contents of the earlier file) into a variable that the parser will read. If the developers aren’t careful and didn’t sanitize their outputs, then their application will display this information to you.</p>
                                
                                <p>Now for a test run, lets see what the output is!</p>
                                
                                
                                <div style="text-align:center"><img src="/images/xxe-attacks/first.png"/></div>
                                
                                <p>As we can see, this file appears to be a list of passwords for various services. Pretty cool right? Now, you may be wondering, “Nick, this doesn’t help me. How am I supposed to know what files are on the system?”. Well, my little peppermint, I have good news for you! You can do directory and file enumeration!</p>
                                
                                <p>To do this, instead of looking for a particular file, leave it on a directory. If I were to change my previous example, it would instead be “file:///home/nick/workspace/XXE/”. Now lets see what happens.</p>
                                
                                <div style="text-align:center"><img src="/img/xxe-attacks/second.png"/></div>
                                
                                <p>Through this method you can search around for files you may want to look at, think etc/passwd or, if running as root, etc/shadow.</p>
                                
                                <h3>Continuing the attack</h3>
                                
                                <p>From here you have more options depending on the configuration (or misconfiguration) of the parser. There are ways to have the parser query over http, meaning if they don’t show the information to the user, you could have it query a web server you control! The problem you will run into is the new line character which typically ends an http packet, however there are some ways around this such as using a protocol like netdoc, gopher, or jar if the parser supports it.</p>
                                
                                <p>If the application is written in PHP and has the Expect module loaded, you can even perform remote code execution! With the prevalence of XML parsers in modern web application the possibilities are endless.</p>
                                
                                <p>For more information on how to harden your web app to this attack check out the OWASP page on it at <a href="https://www.owasp.org/index.php/XML_External_Entity_(XXE)_Processing">this</a> link.</p>
                                
							</article>

					</div>

			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>
