---
title: "Bypass GuardDuty PenTest Alerts"
date: 2019-09-04T17:16:40-06:00
description: A guide to bypass the GuardDuty PenTest Finding Type
link: bypass-guardduty-pentest-alerts
type: "blog"
---
<p>GuardDuty is Amazon Web Service’s (AWS) built in solution for detecting attacks against your environment using machine learning. It can detect a number of common attacks and is an excellent way to quickly boost your security.</p><p>If you are a Penetration Tester working in an environment that uses AWS/GuardDuty there are a number of common findings you need to be aware of. While causing alerts during traditional whitebox penetration testing is not a huge deal, it is often a good idea to be courteous to your blue team friends and reduce the number of alerts you cause.</p><p><a href="https://frichetten.com/blog/hijack-iam-roles-and-avoid-detection">Previously</a> I wrote about how to bypass the <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_unauthorized.html#unauthorized11" style="word-wrap:break-word">UnauthorizedAccess:IAMUser/InstanceCredentialExfiltration</a> finding. Another common finding type you may run into are the <a href="https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_pentest.html">PenTest</a> findings.</p><p>The PenTest finding type covers when GuardDuty detects API invocations coming from a penetration testing Linux distribution. These are <a href="https://www.kali.org/">Kali Linux</a>, <a href="https://parrotlinux.org/">Parrot Linux</a>, and <a href="https://www.pentoo.ch/">Pentoo Linux</a>.</p><p>While we should all be using the one true Linux distribution (<a href="https://www.archlinux.org/">Arch</a>), there can be any number of reasons a Penetration Tester may be required to use one of the aforementioned penetration testing Linux distributions. As such, the following describes how this detection works and how it can be bypassed.</p><p>Note: This has been covered <a href="https://www.thesubtlety.com/post/patching-boto3-useragent/">before</a> <a href="https://www.oreilly.com/library/view/hands-on-aws-penetration/9781789136722/2648af4f-f4ba-457d-9b81-a62d9be056a3.xhtml">elsewhere</a> and is even a feature of <a href="https://github.com/RhinoSecurityLabs/pacu/wiki/Advanced-Capabilities">Pacu</a>, however the following is my explanation.</p><p>First, how does GuardDuty pick up on this finding? The answer lies in the AWS API User-Agent string. According to the <a href="https://github.com/boto/botocore/blob/c274b457a06fd3ae67c6fa158c6411ac0bff4b49/botocore/session.py#L429">Botocore</a> library (a part of the official AWS Python SDK) every request to the AWS API will include a User-Agent string of the following format.</p>

<center><code>&lt;agent_name&gt;/&lt;agent_version&gt; Python/&lt;py_ver&gt; &lt;plat_name&gt;/&lt;plat_ver&gt; &lt;exec_env&gt;</code></center>

<p>This provides us with a good bit of information. The key piece we are looking for is that third part, the platform information. This will inform GuardDuty the type of operating system we are using (for example, Linux) as well as the "platform version".</p><p>Looking at the code, this information comes from the following chunk of code.</p><p style="text-align:center"><img src="/images/blog/bypass-guardduty-pentest-alerts/1.jpg" alt="Showing the code which calls platform.release()" style="max-width:95%" class="img-responsive" /></p><p>Bingo, we have our informant. The AWS CLI (and tools built using boto3) inform AWS of what version of Linux we are using. On Kali Linux the following is the release information.</p><p style="text-align:center"><img src="/images/blog/bypass-guardduty-pentest-alerts/2.png" alt="Showing the output of platform.release() on Kali Linux" style="max-width:95%" class="img-responsive" /></p><p>From here all AWS has to do is detect “kali” and it will trigger the GuardDuty alert.</p><p>To prevent this from happening, we have a few options. One would be to do monkey patching to change the release before calling API functionality. This is effective if you are writing a script and calling the API through that way, however it does not apply to the AWS CLI.</p><p>The method I have chosen to go with (and what I think is the simplest way) is to instead modify your installed <a href="https://github.com/boto/botocore">botocore</a> package and hard code a specific user agent. This way, you can make use of the regular AWS CLI without having to do any proxying or other magic. Note: It's likely better to do Monkey patching if you are shipping a tool or a one off script.</p><p>The steps to do this may differ on what OS you’re using and how you’ve installed botocore/aws cli (pip3/pip/apt/aur/pacman/etc.). Regardless of the OS, you are looking to modify the "session.py" file of your botocore package. On a default Kali Linux install this can be found at /usr/local/lib/python3.7/dist-packages/botocore/session.py.</p><p>From here you will want to scroll down to line 456 (at the time of this writing) and change "platform.release()" to a string of your choosing (for this article I have changed it to "Neat agent string").</p><p>From here that string should be your new User-Agent string. I’d encourage you to test this in your own environment to ensure it is working as intended and it is not picked up on by GuardDuty (I take no responsibility if your opsec gets blown!). If you’d like to see it going over the wire you can set your AWS CLI to go through a proxy (like Burp Suite) by running "export https_proxy=https://proxy_ip:8080". This should give you something like the following.</p><p style="text-align:center"><img src="/images/blog/bypass-guardduty-pentest-alerts/3.jpg" alt="Showing the modified User-Agent in a proxy" style="max-width:95%" class="img-responsive" /></p><p>If you’d like to set a more stealthy User-Agent string, you can choose any of the following samples. These were taken from <a href="https://github.com/RhinoSecurityLabs/pacu/blob/master/user_agents.txt">Pacu</a> (they are legitimate User-Agent strings). Consider modifying the platform.system() call as well.</p>

<center><code>Linux/4.15.0-45-generic<br>Windows/10<br>Mac_OS_X/10.14.2</code></center><br>
