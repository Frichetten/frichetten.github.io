<!DOCTYPE html>
<html>
<!--
   ##########################################
   #░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░#
   #░░░░░░░▄▄▀▀▀▀▀▀▀▀▀▀▄▄█▄░░░░▄░░░░█░░░░░░░#
   #░░░░░░█▀░░░░░░░░░░░░░▀▀█▄░░░▀░░░░░░░░░▄░#
   #░░░░▄▀░░░░░░░░░░░░░░░░░▀██░░░▄▀▀▀▄▄░░▀░░#   Checking out my code? I like you.
   #░░▄█▀▄█▀▀▀▀▄░░░░░░▄▀▀█▄░▀█▄░░█▄░░░▀█░░░░#
   #░▄█░▄▀░░▄▄▄░█░░░▄▀▄█▄░▀█░░█▄░░▀█░░░░█░░░#   Looking to hire me? You can reach
   #▄█░░█░░░▀▀▀░█░░▄█░▀▀▀░░█░░░█▄░░█░░░░█░░░#   me with my contact info. Tell me
   #██░░░▀▄░░░▄█▀░░░▀▄▄▄▄▄█▀░░░▀█░░█▄░░░█░░░#   you found this and I will be much
   #██░░░░░▀▀▀░░░░░░░░░░░░░░░░░░█░▄█░░░░█░░░#   more interested in working for your
   #██░░░░░░░░░░░░░░░░░░░░░█░░░░██▀░░░░█▄░░░#   company!
   #██░░░░░░░░░░░░░░░░░░░░░█░░░░█░░░░░░░▀▀█▄#
   #██░░░░░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░▄▄██#
   #░██░░░░░░░░░░░░░░░░░░▄▀░░░░░█░░░░░░░▀▀█▄#
   #░▀█░░░░░░█░░░░░░░░░▄█▀░░░░░░█░░░░░░░▄▄██#
   #░▄██▄░░░░░▀▀▀▄▄▄▄▀▀░░░░░░░░░█░░░░░░░▀▀█▄#
   #░░▀▀▀▀░░░░░░░░░░░░░░░░░░░░░░█▄▄▄▄▄▄▄▄▄██#
   #░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░#
   ##########################################
-->
	  
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="An introduction to exfiltrating data with ICMP requests.">
    <title>ICMP Tunneling Basics</title>

    <!-- CSS and Fonts -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="css/site-style.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
</head>

<body style="width:100%;height:100%;margin: 0px;padding:0px;overflow-x:hidden;">
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="/">Nicholas Frichette</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
		    <li>
                        <a href="bloghome">Blog</a>
                    </li>
                    <li>
                        <a href="about">About Me</a>
                    </li>
                    <li>
                        <a href="Resume.pdf">Resume</a>
                    </li>
                    <li>
                        <a href="https://github.com/Frichetten">Github</a>
                    </li>
		    <li>
                        <a href="projects">Projects</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Page Header -->
    <header class="intro-header" style="background-image: url('img/tunnel.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="site-heading">
                        <h1>ICMP Tunneling Basics</h1>
                        <hr class="small">
                        <span class="subheading"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container" style="margin-top:-50px">
        <div class="row">
		<div class="center-block" style="margin-left: 15px;margin-right: 15px;">
			<p>
			<b>NOTE: The following information is intended for educational purposes only. I take no responsibility for 
			anyone's actions.<br><br>I tested this on a Linux (Ubuntu) system using Python 2.7.12, I'd suggest you do 
			the same. Conversions can be made very easily if you'd like to use another version of Python. If you use a 
			different OS you may get some errors with the socket creation, however that can be fixed with a quick Google 
			search (plug in the error number you get and go).</b><br><br>
			Data exfiltration can be a tricky art. With so many big name data breaches happening every month, many organizations 
			have invested in DLP (Data Loss Prevention) and SIEM (Security Information and Event Management) systems to prevent 
			data exfiltration events. Unfortunately, there are still ways to tunnel out of a network and I will be discussing 
			the basics of one such method today, 
			<a style="text-decoration:underline" href="https://en.wikipedia.org/wiki/ICMP_tunnel">ICMP Tunneling</a>.<br><br>
			The basics of ICMP (Internet Control Message Protocol) tunneling revolves around using ICMP echo and reply packets 
			to create a channel of communication between two systems. What makes this so efffective is that it can be difficult to 
			block (most organizations can't block ICMP traffic without a lot of hassle) and it can also be difficult to detect 
			if you're careful.<br><br>
			For the purposes of this article, our goal is to write a small bit of code to send and recieve a text file using 
			ICMP tunneling. There are many pre-built solutions you can use such a Loki, or 
			<a style="text-decoration:underline" href="https://github.com/DhavalKapil/icmptunnel">icmptunnel</a>. However 
			i'd like to show how can this can be done from scratch with relatively little effort. In addition, writing your own 
			code should help prevent being noticed by signature based detection. Alright, let's begin!<br>
			<h3>What does an ICMP packet look like?</h3>
			The first goal of any project is to know what you're trying to build. In this instance we are trying to impersonate 
			ICMP requests. The easiest way to know what these look like is to fire up Wireshark and ping your localhost.
			<p style="text-align:center;"><img src="img/icmp-tunneling-basics/1.png" style="max-width:100%;border-width:1px;border-style:solid;border-color:black;"></p>
			There it is! A more astute reader may notice that there is no TCP or UDP header in the packet. This is because ICMP 
			uses a lower level protocol. As a result, this means that when we build our socket we will have to use something called 
			a "raw socket". Let's get right to it shall we? First open up your text editor of choice (Vim). And lets type in a 
			bit of code.<br><br>
			<pre><code>import socket<br>import binascii as b<br><br>try:<br>    sock = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_RAW)
except socket.error, msg:<br>    print 'Error: ' + str(msg[0]) + 'Dont forget to sudo'<br>    exit()<br><br>packet = b.unhexlify('')<br><br>source = '127.0.0.1'<br>dest = '127.0.0.1'<br><br>print packet<br>sock.sendto(packet,(dest,1010))<br><br>sock.close()</code></pre><br>
			Before continuting, lets take a moment to understand what this code is doing, first we import the socket and binascii 
			packages (more on this in a moment). Both of these packages should be shipped standard with any installation of Python. 
			Next we attempt to create a socket object called "sock" for us to interact with. Notice the try catch there? That is 
			because this program will need to be run with root priviledges. Becuase ICMP packets use a lower level networking system, 
			they need access to the lower bits of the system (requiring root). That try catch block will trigger if the socket 
			creation fails (due to priviledges) and will exit the application.<br><br>
			Next, we are creating the actual packet that we intend to send off. There are many different ways to craft a packet in 
			Python. Most developers would recommend the 
			<a style="text-decoration:underline" href="https://docs.python.org/2/library/struct.html">Struct</a> module. However 
			for the purposes of this article we are going to take a much more quick and dirty approach, literally dumping hex 
			strings into packet. This is done using a helpful module called 
			<a style="text-decoration:underline" href="https://docs.python.org/2/library/binascii.html">"binascii"</a>.<br><br>
			What makes this module so useful is that using the "unhexlify" method, we can convert a hex string to binary and send that 
			across the network. The reason I like this method (aside from the fact that it's really cute) is that we can literally 
			copy and paste that hex value we got with Wireshark into our code and run it (The hex string is that middle block 
			of text in the picture above).<br><br>
			Let's try this now, simply copy that long hex string you got from Wireshark into the empty packet variable. Then run the 
			program (be sure to run it as root), and see what you get with Wireshark.
			<p style="text-align:center;"><img src="img/icmp-tunneling-basics/2.png" style="max-width:100%;border-width:1px;border-style:solid;border-color:black;"></p>
			Ta-da! We have successfully sent a ICMP request with no effort at all (which is why I prefer the manual hex packet 
			crafting over Struct in this case). In addition, you can see that our localhost has replied to our request with 
			an ICMP reply packet.
		</div>					
        </div>
    </div>

    <!-- Contact Info -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://github.com/Frichetten">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
			<li>
                            <a href="https://www.linkedin.com/in/nick-frichette-633297126">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

	<!-- JavaScript -->
	<!-- jQuery -->
    <script src="vendor/jquery/jquery.min.js"></script>
	
    <!-- Bootstrap Core JavaScript -->
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Contact Form JavaScript -->
    <script src="js/jqBootstrapValidation.js"></script>
    <script src="js/contact_me.js"></script>

    <!-- Theme JavaScript -->
    <script src="js/clean-blog.min.js"></script>
	
	<!-- Fun Stuff -->
	<script type="text/javascript" src="js/fun.js"></script>

</body>
</html>
